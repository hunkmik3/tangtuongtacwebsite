<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nạp Tiền - Tăng Tương Tác VIP</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    .topup-container{max-width:1200px;margin:24px auto;padding:0 16px}
    .topup-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .topup-grid{display:grid;grid-template-columns:2fr 1.2fr;gap:16px}
    @media(max-width:1080px){.topup-grid{grid-template-columns:1fr}}
    .card{background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08);overflow:hidden}
    .card-body{padding:18px 20px}
    .section-title{display:flex;align-items:center;gap:10px;margin:0 0 12px 0}
    .helper{color:#6b7280;font-size:13px;margin-top:8px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#f1f5ff;color:#3b5bdb;padding:6px 10px;border-radius:999px;font-size:13px}
    .kv{display:grid;grid-template-columns:130px 1fr;gap:6px 12px;margin-top:10px}
    .kv div{display:flex;align-items:center;gap:8px}
    .copy{cursor:pointer;color:#667eea}
    .ndct{background:#16a34a;color:#fff;padding:10px 14px;border-radius:8px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
    .bank-logo{height:38px}
    .qr-wrap{display:flex;justify-content:center;margin-top:14px}
    .qr-img{height:260px;border-radius:12px;border:1px solid #eee}
    .bank-footer{font-size:12px;color:#6b7280;margin-top:10px;text-align:center}
    .note-list{padding-left:18px}
    .controls{display:flex;gap:8px;align-items:center;margin:8px 0}
    .controls input{padding:8px 10px;border:2px solid #e1e5e9;border-radius:8px}
    .stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
    .stat{background:#f8fafc;border:1px solid #eef2f7;border-radius:10px;padding:10px}
    .history-item{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-top:1px solid #f1f3f5}
    .status{padding:4px 10px;border-radius:999px;font-weight:600;font-size:12px}
    .status.completed{background:#ecfdf5;color:#059669}
    .status.pending{background:#fff7ed;color:#d97706}
    .status.failed{background:#fef2f2;color:#dc2626}
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="top-bar-left">
      <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Quay lại</a>
    </div>
    <div class="top-bar-right">
      <div class="dark-mode-toggle"><input type="checkbox" id="darkModeToggle"><label for="darkModeToggle">Dark Mode</label></div>
      <div class="user-info"><span>Xin Chào</span><i class="fas fa-user-circle"></i></div>
      <button class="logout-btn">Đăng Xuất</button>
    </div>
  </div>

  <div class="topup-container">
    <div class="topup-header">
      <h1 style="margin:0">Nạp Tiền</h1>
      <span class="pill"><i class="fas fa-wallet"></i> Số dư: <strong data-user-field="balanceVnd"></strong></span>
    </div>

    <div class="topup-grid">
      <!-- LEFT: QR & bank info -->
      <div class="card">
        <div class="card-body">
          <div class="ndct">NỘI DUNG CHUYỂN TIỀN <span id="ndct-view" style="display:flex;align-items:center;gap:8px"><code id="tu-content-top">---</code> <i class="fas fa-copy copy" id="copy-ndct"></i></span></div>
          <div style="margin-top:16px;display:flex;align-items:center;gap:12px">
            <img class="bank-logo" id="bank-logo" src="https://img.vietqr.io/image/napas-247.png" alt="bank" />
            <img class="bank-logo" src="https://img.vietqr.io/image/vietqr_logo.png" alt="vietqr" />
          </div>
          <div class="kv">
            <div>Tên TK</div><div><span id="bank-name">--</span></div>
            <div>Số TK</div><div><span id="bank-account">--</span> <i class="fas fa-copy copy" id="copy-account"></i></div>
            <div>Nội Dung</div><div><span id="bank-content">--</span> <i class="fas fa-copy copy" id="copy-content"></i></div>
          </div>

          <div class="qr-wrap"><img id="tu-qr" class="qr-img" src="" alt="VietQR"></div>
          <div class="bank-footer" id="bank-footer"></div>

          <div class="card-body" style="padding-top:10px">
            <div class="section-title"><i class="fas fa-qrcode"></i><h3 style="margin:0">Tạo/hiển thị QR nạp tiền</h3></div>
            <div class="controls" style="flex-wrap:wrap;gap:10px">
              <div style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" id="use-static-qr">
                <label for="use-static-qr">Dùng QR cố định của shop</label>
              </div>
              <input type="url" id="static-qr-url" placeholder="Dán URL ảnh QR của bạn (ví dụ: https://...)" style="min-width:320px;flex:1;display:none">
              <button class="btn btn-secondary" id="save-static-qr" style="display:none"><i class="fas fa-save"></i> Lưu QR</button>
            </div>
            <div class="controls">
              <input type="number" id="tu-amount" min="10000" step="10000" value="100000" placeholder="Nhập số tiền (VND)">
              <button class="btn btn-primary" id="tu-create"><i class="fas fa-qrcode"></i> Tạo QR động</button>
            </div>
            <div class="helper">Tối thiểu 10.000 VND • Nếu bật QR cố định, khách vẫn cần <strong>ghi đúng nội dung</strong> hệ thống cung cấp để cộng tiền tự động/thủ công.</div>
          </div>
        </div>
      </div>
      <!-- RIGHT: Notes & history -->
      <div class="card">
        <div class="card-body">
          <div class="section-title"><i class="fas fa-info-circle"></i><h3 style="margin:0">Ghi chú</h3></div>
          <ul class="note-list">
            <li>Có thể chuyển khoản từ <strong>mọi ngân hàng</strong> tới tài khoản hiển thị bên trái.</li>
            <li><strong>Ghi đúng</strong> nội dung chuyển tiền được cung cấp.</li>
            <li>Không sửa dấu/tiếng Việt ở nội dung chuyển khoản.</li>
            <li>Hệ thống tự động cộng sau vài giây. Quá 10 phút chưa cộng vui lòng liên hệ hỗ trợ.</li>
          </ul>

          <div class="controls">
            <input type="date" id="tk-from">
            <span>đến</span>
            <input type="date" id="tk-to">
            <button class="btn btn-secondary" id="tk-view">Xem</button>
          </div>

          <div class="stat-grid">
            <div class="stat"><div class="helper">Tổng nạp</div><div id="sum-topup" style="font-weight:700">₫0</div></div>
            <div class="stat"><div class="helper">Tổng chi</div><div id="sum-spent" style="font-weight:700">₫0</div></div>
          </div>

          <div class="section-title" style="margin-top:14px"><i class="fas fa-list"></i><h3 style="margin:0">Lịch sử nạp</h3></div>
          <div id="tu-history"><div class="helper">Chưa có giao dịch</div></div>
        </div>
      </div>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    (function(){
      const btn = document.getElementById('tu-create');
      const amountEl = document.getElementById('tu-amount');
      const ndctTop = document.getElementById('tu-content-top');
      const bankNameEl = document.getElementById('bank-name');
      const bankAccountEl = document.getElementById('bank-account');
      const bankContentEl = document.getElementById('bank-content');
      const bankFooterEl = document.getElementById('bank-footer');
      const copyNdct = document.getElementById('copy-ndct');
      const copyAccount = document.getElementById('copy-account');
      const copyContent = document.getElementById('copy-content');
      const qrImg = document.getElementById('tu-qr');
      const contentCodeEl = document.getElementById('tu-content');
      const amountView = document.getElementById('tu-amount-view');
      const useStaticQr = document.getElementById('use-static-qr');
      const staticQrUrl = document.getElementById('static-qr-url');
      const saveStaticQr = document.getElementById('save-static-qr');
      const historyEl = document.getElementById('tu-history');
      const fmt = (v)=> `₫${(v||0).toLocaleString('vi-VN')}`;

      function applyStaticState(){
        const enabled = localStorage.getItem('topup.staticQr.enabled') === 'true';
        const url = localStorage.getItem('topup.staticQr.url') || '';
        if (useStaticQr) useStaticQr.checked = enabled;
        if (staticQrUrl) staticQrUrl.style.display = enabled ? 'block' : 'none';
        if (saveStaticQr) saveStaticQr.style.display = enabled ? 'inline-flex' : 'none';
        if (enabled && url && qrImg) {
          qrImg.src = url;
        }
        if (staticQrUrl && !staticQrUrl.value) staticQrUrl.value = url;
      }

      if (useStaticQr) {
        useStaticQr.addEventListener('change', ()=>{
          localStorage.setItem('topup.staticQr.enabled', useStaticQr.checked ? 'true' : 'false');
          applyStaticState();
        });
      }
      if (saveStaticQr) {
        saveStaticQr.addEventListener('click', ()=>{
          const url = (staticQrUrl?.value || '').trim();
          if (url) {
            try { new URL(url); } catch { alert('URL ảnh QR không hợp lệ'); return; }
            localStorage.setItem('topup.staticQr.url', url);
            applyStaticState();
            alert('Đã lưu QR cố định.');
          }
        });
      }

      async function loadHistory(){
        try{
          const token = localStorage.getItem('auth.token');
          const base = (localStorage.getItem('api.base')) || `${location.protocol}//${location.hostname}:4000`;
          const res = await fetch(`${base}/api/topups`, { headers: { 'Authorization': token?`Bearer ${token}`:'' } });
          const items = await res.json();
          let sumTopup = 0; let sumSpent = 0;
          const html = (items||[]).map(t=>{
            const created = new Date(t.createdAt).toLocaleString('vi-VN');
            const s = String(t.status).toLowerCase();
            const label = {pending:'Đang chờ',completed:'Thành công',failed:'Thất bại',canceled:'Hủy'}[s]||t.status;
            if (s==='completed') sumTopup += (t.amountVnd||0);
            return `<div class=\"history-item\"><div><div><strong>${fmt(t.amountVnd)}</strong></div><div class=\"helper\">${created} • ${t.contentCode||''}</div></div><span class=\"status ${s}\">${label}</span></div>`;
          }).join('');
          historyEl.innerHTML = html || '<div class="helper">Chưa có giao dịch</div>';
          document.getElementById('sum-topup').textContent = fmt(sumTopup);
          document.getElementById('sum-spent').textContent = fmt(sumSpent);
        }catch{}
      }

      btn.addEventListener('click', async ()=>{
        const amount = Math.max(parseInt(amountEl.value)||0, 10000);
        btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo...';
        try{
          const token = localStorage.getItem('auth.token');
          const base = (localStorage.getItem('api.base')) || `${location.protocol}//${location.hostname}:4000`;
          const res = await fetch(`${base}/api/topup/create`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': token?`Bearer ${token}`:'' }, body: JSON.stringify({ amountVnd: amount }) });
          const data = await res.json(); if (!res.ok) throw new Error(data.error||('HTTP '+res.status));
          const enabled = localStorage.getItem('topup.staticQr.enabled') === 'true';
          const staticUrl = localStorage.getItem('topup.staticQr.url') || '';
          if (enabled && staticUrl) { qrImg.src = staticUrl; } else { qrImg.src = data.qrUrl; }
          if (contentCodeEl) contentCodeEl.textContent = data.contentCode; 
          if (ndctTop) ndctTop.textContent = data.contentCode;
          bankNameEl.textContent = data.bank?.name || '-';
          bankAccountEl.textContent = data.bank?.account || '-';
          bankContentEl.textContent = data.contentCode || '-';
          bankFooterEl.textContent = `Nội dung CK: ${data.contentCode} • Chủ TK: ${data.bank?.name||''} • Số TK: ${data.bank?.account||''}`;
          if (amountView) amountView.textContent = fmt(data.amountVnd);
          // copy helpers
          function copy(text){ navigator.clipboard.writeText(text).catch(()=>{}); }
          copyNdct.onclick = ()=> copy(data.contentCode||'');
          copyAccount.onclick = ()=> copy(data.bank?.account||'');
          copyContent.onclick = ()=> copy(data.contentCode||'');
          loadHistory();
        }catch(err){ alert(err.message||'Không tạo được QR'); }
        finally{ btn.disabled = false; btn.innerHTML = '<i class="fas fa-qrcode"></i> Tạo QR động'; }
      });

      loadHistory();
      applyStaticState();
    })();
  </script>
</body>
</html>


